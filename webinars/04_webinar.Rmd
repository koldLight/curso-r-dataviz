---
title: "SMD - Visualización de datos - Webinar 4"
author: "Luz Frias"
date: "2020-11-10"
output:
  html_document:
    highlight: tango
    theme: flatly
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = "..")
knitr::opts_chunk$set(message = FALSE, warning = FALSE)
library(dplyr)
library(tidyr)
```

## Introducción

Estas son las soluciones al fastbook 8. No incluyo las soluciones al fastbook 7 ya que son libres. También se incluye una parte dedicada a aclarar los conceptos de `join` y formatos ancho y largo.

Algunas aclaraciones:

* Este documento está con encoding UTF-8. Si lo abres desde windows, es posible que veas mal los caracteres especiales (tildes, eñes, ...). Lo puedes arreglar, en RStudio, haciendo click en File / Reopen with encoding y eligiendo UTF-8
* Las rutas a los ficheros suponen que, en la misma carpeta en la que tienes este documento, está `dat/` con los archivos de datos necesarios. Si no te funciona, es que los tienes en otra parte y tendrás que modificar esas rutas.

## Fastbook 8 - Flexdashboard

### Actividad 1

Crea un cuadro de mando con flexdashboard con tres gráficas de tu elección de algún _dataset_ visto en los fastbooks anteriores. A partir de él, genera las siguientes versiones:

* Una columna con una gráfica, la otra con dos. Sin scroll vertical.
* Tres filas, cada una con una gráfica. Con scroll vertical.
* Una fila con una gráfica, la otra con dos. Sin scroll vertical.
* Una fila con una gráfica, la otra con dos pestañas, cada una de ellas con una gráfica. Sin scroll vertical.

### Actividad 2

Utilizando el dataset de AirBnB `listings.csv`, que contiene un resumen de los datos más relevantes por cada alojamiento, crea un cuadro de mando con _flexdashboard_ que tenga:

* Cajas de valores con:

    * El número de alojamientos totales
    * El precio medio por noche
    * El porcentaje que son alojamientos completos
    * El porcentaje que son habitaciones privadas

* Un mapa con pequeños marcadores donde se sitúan los alojamientos (cada tipo de alojamiento con un color diferente). Si tiene demasiados datos y tarda mucho en cargar, puedes coger un subconjunto aleatorio de los datos.

* Una gráfica de barras con la cantidad de alojamientos por tipo de habitación.

_Bonus_: amplía tu dashboard con más páginas y gráficas, intentando reproducir la información mostrada [aquí](http://insideairbnb.com/madrid/#).

## Cruces y formatos ancho y largo

Vamos a fabricar unos datos para ilustrar los ejemplos:

```{r}
set.seed(1234)

provincias <- data.frame(
  id_provincia = 1:3,
  nombre_provincia = c("Zaragoza", "Huesca", "Teruel")
)

# Fíjate en como se resuelve una relación 1:n (1 provincia : n clientes)
# Se introduce una columna en la tabla
clientes <- data.frame(
  id_cliente        = 1:4,
  nombre_cliente    = c("Ana", "Rosa", "Carlos", "Miguel"),
  id_provincia      = c(2, 1, 3, 1)
)

productos <- data.frame(
  id_producto     = 1:6,
  nombre_producto = c("Portátil", "Monitor", "Disco duro",
                      "Smartphone", "Tarjeta gráfica", "Teclado"),
  precio_producto = c(700, 150, 80, 250, 120, 25)
)

# Fíjate en como se resuelve una relación n:m (n productos : m clientes)
# Se crea una tabla nueva de relación
ventas <- data.frame(
  id_cliente     = rep(1:3, times = c(10, 3, 1)),
  id_producto    = c(1, 1, 1, 2, 2, 2, 4, 4, 4, 3,  # Compras cliente 1
                     1, 1, 5,                       # Compras cliente 2
                     2),                            # Compras cliente 3
  unidades       = c(5, 2, 1, 7, 3, 1, 1, 1, 1, 1,
                     1, 1, 1,
                     2),
  fecha_venta    = sample(seq(as.Date("2019-10-01"), as.Date("2019-10-31"), by = "day"), 14)
)
```

Y contestemos a las siguientes preguntas:

* Lista los productos, con el número de unidades que se han vendido. Sin ver los que no han tenido ventas.

```{r}
productos %>%
  inner_join(ventas, by = "id_producto") %>%
  group_by(nombre_producto) %>%
  summarise(num_ventas = sum(unidades))
```

* Ídem, pero viendo los que no han tenido ventas.

```{r}
ventas %>%
  right_join(productos, by = "id_producto") %>%
  group_by(nombre_producto) %>%
  summarise(num_ventas = sum(unidades, na.rm = TRUE))
```

* Lista el importe total vendido por cada provincia.

```{r}
ventas %>%
  inner_join(productos, by = "id_producto") %>%
  inner_join(clientes, by = "id_cliente") %>%
  inner_join(provincias, by = "id_provincia") %>%
  group_by(nombre_provincia) %>%
  summarise(importe_ventas = sum(unidades * precio_producto))
```

* Muestra los clientes que no han comprado nada

```{r}
clientes %>%
  anti_join(ventas, by = "id_cliente")
```

```{r}
clientes %>%
  left_join(ventas, by = "id_cliente") %>%
  filter(is.na(id_producto))
```

* Muestra una tabla con las ventas por producto y cliente (las filas son los clientes, las columnas los productos)

```{r}
ventas_largo <- ventas %>%
  inner_join(productos, by = "id_producto") %>%
  inner_join(clientes, by = "id_cliente") %>%
  group_by(nombre_cliente, nombre_producto) %>%
  summarise(
    ventas = sum(unidades)
  )

ventas_largo
```

```{r}
ventas_ancho <- ventas_largo %>%
  pivot_wider(
    id_cols     = nombre_cliente,
    names_from  = nombre_producto,
    values_from = ventas,
    values_fill = 0
  )

ventas_ancho
```


